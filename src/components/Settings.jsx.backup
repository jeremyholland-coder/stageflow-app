import React, { useState, useEffect, useRef, useCallback, Suspense, lazy } from 'react';
import {
  ArrowLeft, Crown, Users, Database, Lock, Bell,
  Shield, LogOut, Sparkles, TrendingUp, Zap, Loader2, Bot, CreditCard,
  CheckCircle, CheckCircle2, XCircle, AlertCircle, ExternalLink, GitBranch,
  RefreshCw, Wrench, EyeOff
} from 'lucide-react';
import { useApp } from './AppShell';
import { supabase, VIEWS } from '../lib/supabase';
import { parseSupabaseError } from '../lib/error-handler';

// PERFORMANCE: Lazy load heavy Settings tabs to reduce initial bundle
// This improves Settings page load time by ~100KB+ and enables better code splitting
const BillingSettings = lazy(() => import('./BillingSettings'));
// CRITICAL FIX: GeneralSettings uses named export, need to unwrap it
const GeneralSettings = lazy(() => import('./GeneralSettings').then(module => ({ default: module.GeneralSettings })));
import { RevenueTargets } from './RevenueTargets';
import { HiddenStages } from './HiddenStages';
// FIX PHASE 10: Import centralized plan limits
import { getPlanLimits } from '../config/planLimits';
import { getPipelineHealth, recoverOrphanedDeals } from '../utils/dealRecovery';
import { PIPELINE_TEMPLATES } from '../config/pipelineTemplates';
import { OrphanedDealsModal } from './OrphanedDealsModal';
import { logger } from '../lib/logger';

// AI Provider Logo Components (same as AISettings.jsx for consistency)
const OpenAILogo = () => (
  <svg viewBox="0 0 24 24" className="w-full h-full" fill="currentColor">
    <path d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494zM3.6 18.304a4.47 4.47 0 0 1-.535-3.014l.142.085 4.783 2.759a.771.771 0 0 0 .78 0l5.843-3.369v2.332a.08.08 0 0 1-.033.062L9.74 19.95a4.5 4.5 0 0 1-6.14-1.646zM2.34 7.896a4.485 4.485 0 0 1 2.366-1.973V11.6a.766.766 0 0 0 .388.676l5.815 3.355-2.02 1.168a.076.076 0 0 1-.071 0l-4.83-2.786A4.504 4.504 0 0 1 2.34 7.896zm16.597 3.855l-5.833-3.387L15.119 7.2a.076.076 0 0 1 .071 0l4.83 2.791a4.494 4.494 0 0 1-.676 8.105v-5.678a.79.79 0 0 0-.407-.667zm2.01-3.023l-.141-.085-4.774-2.782a.776.776 0 0 0-.785 0L9.409 9.23V6.897a.066.066 0 0 1 .028-.061l4.83-2.787a4.5 4.5 0 0 1 6.68 4.66zm-12.64 4.135l-2.02-1.164a.08.08 0 0 1-.038-.057V6.075a4.5 4.5 0 0 1 7.375-3.453l-.142.08-4.778 2.758a.795.795 0 0 0-.393.681zm1.097-2.365l2.602-1.5 2.607 1.5v2.999l-2.597 1.5-2.607-1.5z"/>
  </svg>
);

const ClaudeLogo = () => (
  <svg viewBox="0 0 50 50" className="w-full h-full" fill="currentColor">
    <path d="M19.861,27.625v-0.716l-16.65-0.681L2.07,25.985 L1,24.575l0.11-0.703l0.959-0.645l17.95,1.345l0.11-0.314L5.716,14.365l-0.729-0.924l-0.314-2.016L5.985,9.98l2.214,0.24 l11.312,8.602l0.327-0.353L12.623,5.977c0,0-0.548-2.175-0.548-2.697l1.494-2.029l0.827-0.266l2.833,0.995l7.935,17.331h0.314 l1.348-14.819l0.752-1.822l1.494-0.985l1.167,0.557l0.959,1.374l-2.551,14.294h0.425l0.486-0.486l8.434-10.197l1.092-0.862h2.065 l1.52,2.259l-0.681,2.334l-7.996,11.108l0.146,0.217l0.376-0.036l12.479-2.405l1.666,0.778l0.182,0.791l-0.655,1.617l-15.435,3.523 l-0.084,0.062l0.097,0.12l13.711,0.814l1.578,1.044L49,29.868l-0.159,0.972l-2.431,1.238l-13.561-3.254h-0.363v0.217l11.218,10.427 l0.256,1.154l-0.645,0.911l-0.681-0.097l-9.967-8.058h-0.256v0.34l5.578,8.35l0.243,2.162l-0.34,0.703l-1.215,0.425l-1.335-0.243 l-7.863-12.083l-0.279,0.159l-1.348,14.524l-0.632,0.742l-1.459,0.558l-1.215-0.924L21.9,46.597l2.966-14.939l-0.023-0.084 l-0.279,0.036L13.881,45.138l-0.827,0.327l-1.433-0.742l0.133-1.326l0.801-1.18l9.52-12.019l-0.013-0.314h-0.11l-12.69,8.239 l-2.259,0.292L6.03,37.505l0.12-1.494l0.46-0.486L19.861,27.625z"/>
  </svg>
);

const GeminiLogo = () => (
  <svg viewBox="0 0 50 50" className="w-full h-full" fill="currentColor">
    <path d="M49.04,24.001l-1.082-0.043h-0.001C36.134,23.492,26.508,13.866,26.042,2.043L25.999,0.96C25.978,0.424,25.537,0,25,0 s-0.978,0.424-0.999,0.96l-0.043,1.083C23.492,13.866,13.866,23.492,2.042,23.958L0.96,24.001C0.424,24.022,0,24.463,0,25 c0,0.537,0.424,0.978,0.961,0.999l1.082,0.042c11.823,0.467,21.449,10.093,21.915,21.916l0.043,1.083C24.022,49.576,24.463,50,25,50 s0.978-0.424,0.999-0.96l0.043-1.083c0.466-11.823,10.092-21.449,21.915-21.916l1.082-0.042C49.576,25.978,50,25.537,50,25 C50,24.463,49.576,24.022,49.04,24.001z"/>
  </svg>
);

const GrokLogo = () => (
  <svg viewBox="0 0 48 48" className="w-full h-full" fill="currentColor">
    <path d="M18.542 30.532l15.956-11.776c.783-.576 1.902-.354 2.274.545 1.962 4.728 1.084 10.411-2.819 14.315-3.903 3.901-9.333 4.756-14.299 2.808l-5.423 2.511c7.778 5.315 17.224 4 23.125-1.903 4.682-4.679 6.131-11.058 4.775-16.812l.011.011c-1.966-8.452.482-11.829 5.501-18.735C47.759 1.332 47.88 1.166 48 1l-6.602 6.599V7.577l-22.86 22.958M15.248 33.392c-5.582-5.329-4.619-13.579.142-18.339 3.521-3.522 9.294-4.958 14.331-2.847l5.412-2.497c-.974-.704-2.224-1.46-3.659-1.994-6.478-2.666-14.238-1.34-19.505 3.922C6.904 16.701 5.31 24.488 8.045 31.133c2.044 4.965-1.307 8.48-4.682 12.023C2.164 44.411.967 45.67 0 47l15.241-13.608"/>
  </svg>
);

// AI Provider configuration mapping
const PROVIDER_CONFIGS = {
  'openai': { Logo: OpenAILogo, color: '#10A37F', displayName: 'ChatGPT' },
  'anthropic': { Logo: ClaudeLogo, color: '#D97757', displayName: 'Claude' },
  'google': { Logo: GeminiLogo, color: '#4285F4', displayName: 'Gemini' },
  'xai': { Logo: GrokLogo, color: '#1ABC9C', displayName: 'Grok' }
};

// CRITICAL FIX: UI components must be defined OUTSIDE Settings to prevent React error #310
// Defining components inside render functions causes them to be recreated on every render
const ProgressBar = ({ current, max }) => {
  // Handle edge cases: 0/0, unlimited, infinity
  const isUnlimited = max === -1 || max === Infinity;
  let percentage = 0;

  if (isUnlimited) {
    percentage = 0; // Show empty bar for unlimited
  } else if (max === 0) {
    percentage = 0; // 0/0 case - show 0%
  } else {
    percentage = Math.min((current / max) * 100, 100);
  }

  const isNearLimit = percentage > 80;

  return (
    <div className="space-y-1">
      <div className="flex justify-between text-sm">
        <span className="text-gray-400">
          {current.toLocaleString()} / {isUnlimited ? '∞' : max.toLocaleString()}
        </span>
        <span className={`font-medium ${isUnlimited ? 'text-teal-400' : isNearLimit ? 'text-amber-400' : 'text-teal-400'}`}>
          {isUnlimited ? 'Unlimited' : `${Math.round(percentage || 0)}%`}
        </span>
      </div>
      <div className="h-2 bg-gray-800 rounded-full overflow-hidden">
        <div
          className={`h-full rounded-full transition-all duration-500 ${
            isUnlimited ? 'bg-gradient-to-r from-teal-500 to-teal-600' :
            isNearLimit ? 'bg-amber-500' : 'bg-gradient-to-r from-teal-500 to-teal-600'
          }`}
          style={{ width: isUnlimited ? '100%' : `${percentage}%` }}
        />
      </div>
    </div>
  );
};

const SettingCard = ({ children, className = '', ...props }) => (
  <div className={`bg-gradient-to-br from-gray-900 to-black rounded-xl p-6 border border-teal-500/30 shadow-xl ${className}`} {...props}>
    {children}
  </div>
);

// PERFORMANCE: Fallback for lazy-loaded Settings tabs
const TabFallback = () => (
  <div className="max-w-4xl mx-auto space-y-6 animate-pulse">
    <div className="bg-gradient-to-br from-gray-900 to-black rounded-xl p-6 border border-teal-500/30 shadow-xl">
      <div className="h-6 bg-gray-800/50 rounded w-1/3 mb-4" />
      <div className="space-y-3">
        <div className="h-4 bg-gray-800/50 rounded w-full" />
        <div className="h-4 bg-gray-800/50 rounded w-5/6" />
        <div className="h-4 bg-gray-800/50 rounded w-4/6" />
      </div>
    </div>
  </div>
);

const SectionTitle = ({ children, icon: Icon }) => (
  <div className="flex items-center gap-2 mb-4">
    <Icon className="w-5 h-5 text-teal-400" />
    <h3 className="text-title-3 text-white">{children}</h3>
  </div>
);

const Toggle = ({ checked, onChange, disabled = false, saving = false }) => (
  <label className={`relative inline-block w-10 h-6 ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}>
    <input
      type="checkbox"
      className="sr-only peer"
      checked={checked}
      onChange={(e) => onChange(e.target.checked)}
      disabled={disabled || saving}
    />
    <div className="w-full h-full bg-gray-700 rounded-full peer-checked:bg-teal-500 transition"></div>
    <div className="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-4"></div>
  </label>
);

export const Settings = () => {
  // Get app context
  const context = useApp();
  const { user, organization, userRole, setActiveView, logout, addNotification, setAvatarUrl } = context || {};

  // CRITICAL: All hooks must be called BEFORE any conditional returns (React Rules of Hooks)
  const [activeTab, setActiveTab] = useState('general');
  const [usageData, setUsageData] = useState({ deals: 0, users: 0, aiRequests: 0 });
  const [dealCount, setDealCount] = useState(0);
  const [teamCount, setTeamCount] = useState(1);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  
  // AI Usage State
  const [aiProviders, setAiProviders] = useState([]);
  const [aiUsage, setAiUsage] = useState({ used: 0, limit: 0 });
  const [loadingAI, setLoadingAI] = useState(true);
  
  // Notification preferences
  const [notifPrefs, setNotifPrefs] = useState({
    all_notifications: true,
    notify_deal_created: true,
    notify_stage_changed: true,
    notify_deal_won: true,
    notify_deal_lost: false,
    weekly_digest: false,
    digest_day: 'monday',
    digest_time: '09:00',
    digest_timezone: Intl.DateTimeFormat().resolvedOptions().timeZone, // Auto-detect user timezone
    digest_time_format: '12h' // '12h' or '24h'
  });
  const [uploadingImage, setUploadingImage] = useState(false);
  const [profilePicUrl, setProfilePicUrl] = useState(null);
  const fileInputRef = useRef(null);

  // Pipeline health state
  const [pipelineHealth, setPipelineHealth] = useState(null);
  const [loadingHealth, setLoadingHealth] = useState(false);
  const [recovering, setRecovering] = useState(false);
  const [showOrphanedDealsModal, setShowOrphanedDealsModal] = useState(false);

  // Check URL parameters for tab selection (runs once on mount)
  // OPTIMIZATION FIX: Only needs to run once on mount - URL params don't change without remount
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const tabParam = params.get('tab');

    if (tabParam && ['general', 'billing', 'pipeline', 'notifications'].includes(tabParam)) {
      logger.log(`Settings: Switching to ${tabParam} tab from URL parameter`);
      setActiveTab(tabParam);
      // Clear URL parameter after reading it (clean URL)
      window.history.replaceState({}, '', window.location.pathname);
    }
  }, []); // OPTIMIZATION FIX: Empty deps = runs only once on mount, sufficient for deep links

  const checkPipelineHealth = useCallback(async () => {
    if (!organization?.id) return;

    // CRITICAL FIX: Track mounted state to prevent memory leaks
    let isMounted = true;
    let timeoutId = null;

    if (isMounted) setLoadingHealth(true);

    try {
      // CRITICAL FIX: Add timeout protection with proper cleanup
      const timeoutPromise = new Promise((_, reject) => {
        timeoutId = setTimeout(() => reject(new Error('Pipeline health check timed out')), 5000);
      });

      const template = PIPELINE_TEMPLATES[organization.pipeline_template || 'default'];

      // Safety check: Ensure template exists and has stages
      if (!template || !template.stages || !Array.isArray(template.stages)) {
        console.warn('[Settings] Invalid pipeline template:', organization.pipeline_template);
        if (isMounted) setLoadingHealth(false);
        return;
      }

      const stages = template.stages.map((s, i) => ({ id: s.id, name: s.name, stage_order: i }));

      const health = await Promise.race([
        getPipelineHealth(organization.id, stages),
        timeoutPromise
      ]);

      // Only update state if component is still mounted
      if (isMounted) {
        setPipelineHealth(health);
      }
    } catch (error) {
      console.error('Error checking pipeline health:', error);
      if (isMounted && !error.message?.includes('timed out')) {
        addNotification('Failed to check pipeline health', 'error');
      }
    } finally {
      // Clear timeout to prevent memory leak
      if (timeoutId) {
        clearTimeout(timeoutId);
      }
      if (isMounted) {
        setLoadingHealth(false);
      }
    }

    // Cleanup function
    return () => {
      isMounted = false;
      if (timeoutId) {
        clearTimeout(timeoutId);
      }
    };
  }, [organization?.id, organization?.pipeline_template]); // CRITICAL FIX: Use stable primitives, not entire object

  // Load pipeline health when pipeline tab is active
  useEffect(() => {
    if (activeTab === 'pipeline' && organization?.id) {
      checkPipelineHealth();
    }
  }, [activeTab, organization?.id, checkPipelineHealth]); // CRITICAL FIX: Depend on organization.id, not organization

  const handleRecoverDeals = () => {
    setShowOrphanedDealsModal(true);
  };

  const handleOrphanedDealsSuccess = async () => {
    addNotification('Orphaned deals recovered successfully!', 'success');
    // Refresh pipeline health
    await checkPipelineHealth();
    // Force a full page refresh to reload deals in Dashboard
    window.location.reload();
  };

  // Load notification preferences from localStorage on mount
  useEffect(() => {
    const saved = localStorage.getItem('stageflow_notification_prefs');
    if (saved) {
      let parsed = {};
      try {
        parsed = JSON.parse(saved);
      } catch (error) {
        console.error('Failed to parse saved notification preferences:', error);
        parsed = {};
      }
      if (Object.keys(parsed).length > 0) {
        setNotifPrefs({ ...notifPrefs, ...parsed });
      }
    }
  }, []);

  // Load existing profile picture on mount
  useEffect(() => {
    let isMounted = true;
    const loadProfilePicture = async () => {
      if (!supabase || !user) return;

      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('avatar_url')
          .eq('id', user.id)
          .maybeSingle();

        if (error && error.code !== 'PGRST116') throw error;

        if (isMounted && data?.avatar_url) {
          setProfilePicUrl(data.avatar_url);
        }
      } catch (error) {
        console.error('Failed to load profile picture:', error);
      }
    };

    loadProfilePicture();

    return () => {
      isMounted = false;
    };
  }, [user]);

  // FIX HIGH #2: Remove duplicate plan limits definition - use centralized config
  // CRITICAL: Must use useMemo to prevent execution during guard evaluation
  const currentPlanTier = React.useMemo(() => organization?.plan_tier || 'free', [organization]);
  const limits = React.useMemo(() => getPlanLimits(currentPlanTier), [currentPlanTier]);

  // Fetch AI providers and usage
  useEffect(() => {
    let isMounted = true;
    
    const fetchAIData = async () => {
      if (!supabase || !user || !organization) {
        if (isMounted) setLoadingAI(false);
        return;
      }

      try {
        // Fetch AI providers
        const { data: providers, error: providerError } = await supabase
          .from('ai_providers')
          .select('*')
          .eq('created_by', user.id)
          .eq('organization_id', organization.id)
          .eq('active', true);

        if (providerError) throw providerError;

        // Fetch organization AI usage
        // CRITICAL FIX: Use maybeSingle() instead of single() to prevent errors
        const { data: orgData, error: orgError } = await supabase
          .from('organizations')
          .select('ai_requests_used_this_month, plan')
          .eq('id', organization.id)
          .maybeSingle();

        if (orgError && orgError.code !== 'PGRST116') throw orgError;

        // Get plan limits
        const planLimits = {
          'free': 100,
          'startup': 1000,
          'growth': 5000,
          'pro': -1 // -1 means unlimited
        };
        const limit = planLimits[orgData.plan?.toLowerCase()] || 100;

        if (isMounted) {
          setAiProviders(providers || []);
          setAiUsage({
            used: orgData.ai_requests_used_this_month || 0,
            limit: limit
          });
        }
      } catch (error) {
        console.error('Failed to fetch AI data:', error);
      } finally {
        if (isMounted) setLoadingAI(false);
      }
    };
    
    fetchAIData();
    
    return () => {
      isMounted = false;
    };
  }, [organization, user]);

  useEffect(() => {
    let isMounted = true;
    
    const fetchUsageData = async () => {
      if (!supabase || !organization) {
        if (isMounted) setLoading(false);
        return;
      }

      try {
        const { count: dealsCount } = await supabase
          .from('deals')
          .select('*', { count: 'exact', head: true })
          .eq('organization_id', organization.id);

        if (isMounted && dealsCount !== null) setDealCount(dealsCount);

        const { count: membersCount } = await supabase
          .from('team_members')
          .select('*', { count: 'exact', head: true })
          .eq('organization_id', organization.id);

        // CRITICAL: membersCount can be 0 for brand new orgs, but user IS logged in
        // Always show at least 1 (the current user)
        if (isMounted && membersCount !== null) {
          setTeamCount(Math.max(membersCount, 1));
        }
      } catch (error) {
        console.error('Failed to fetch usage data:', error);
        if (isMounted) {
          const parsedError = parseSupabaseError(error);
          addNotification(parsedError.message, 'error');
        }
      } finally {
        if (isMounted) setLoading(false);
      }
    };

    const fetchNotificationPreferences = async () => {
      if (!supabase || !user || !organization) return;

      try {
        const { data, error } = await supabase
          .from('notification_preferences')
          .select('*')
          .eq('user_id', user.id)
          .eq('organization_id', organization.id)
          .maybeSingle();

        if (error && error.code !== 'PGRST116') throw error;

        if (isMounted && data) {
          setNotifPrefs({
            all_notifications: data.all_notifications,
            notify_deal_created: data.notify_deal_created,
            notify_stage_changed: data.notify_stage_changed,
            notify_deal_won: data.notify_deal_won,
            notify_deal_lost: data.notify_deal_lost,
            weekly_digest: data.weekly_digest,
            digest_day: data.digest_day || 'monday',
            digest_time: data.digest_time || '09:00',
            digest_timezone: data.digest_timezone || Intl.DateTimeFormat().resolvedOptions().timeZone,
            digest_time_format: data.digest_time_format || '12h'
          });
        }
      } catch (error) {
        console.error('Failed to fetch notification preferences:', error);
        if (isMounted) {
          const parsedError = parseSupabaseError(error);
          addNotification(parsedError.message, 'error');
        }
      }
    };
    
    fetchUsageData();
    fetchNotificationPreferences();
    
    return () => {
      isMounted = false;
    };
  }, [organization, user]);

  // Guard: Don't render until user and organization are loaded
  // MUST be placed AFTER all hooks to comply with React Rules of Hooks
  if (!user || !organization) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="flex flex-col items-center gap-3">
          <Loader2 className="w-8 h-8 animate-spin text-teal-400" />
          <span className="text-sm text-gray-400">Loading settings...</span>
        </div>
      </div>
    );
  }

  const saveNotificationPreferences = async (newPrefs) => {
    setSaving(true);
    try {
      // Save to localStorage for immediate persistence
      localStorage.setItem('stageflow_notification_prefs', JSON.stringify(newPrefs));

      // FIX: Try insert first, then update if exists
      if (supabase && user && organization) {
        // Add timeout wrapper to prevent infinite hangs
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error('Database operation timed out')), 10000)
        );

        // Check if record exists
        const { data: existing } = await Promise.race([
          supabase
            .from('notification_preferences')
            .select('user_id')
            .eq('user_id', user.id)
            .eq('organization_id', organization.id)
            .maybeSingle(),
          timeoutPromise
        ]);

        const prefsData = {
          user_id: user.id,
          organization_id: organization.id,
          all_notifications: newPrefs.all_notifications,
          notify_deal_created: newPrefs.notify_deal_created,
          notify_stage_changed: newPrefs.notify_stage_changed,
          notify_deal_won: newPrefs.notify_deal_won,
          notify_deal_lost: newPrefs.notify_deal_lost,
          weekly_digest: newPrefs.weekly_digest,
          digest_day: newPrefs.digest_day,
          digest_time: newPrefs.digest_time,
          digest_timezone: newPrefs.digest_timezone,
          digest_time_format: newPrefs.digest_time_format
        };

        let error;
        if (existing) {
          // Update existing record with timeout
          const result = await Promise.race([
            supabase
              .from('notification_preferences')
              .update(prefsData)
              .eq('user_id', user.id)
              .eq('organization_id', organization.id),
            timeoutPromise
          ]);
          error = result.error;
        } else {
          // Insert new record with timeout
          const result = await Promise.race([
            supabase
              .from('notification_preferences')
              .insert(prefsData),
            timeoutPromise
          ]);
          error = result.error;
        }

        if (error) {
          console.error('❌ Database save error:', error);
          addNotification(`Database error: ${error.message}. Settings saved locally.`, 'error');
          // Don't throw - localStorage still works
        }
      }

      // REMOVED: Don't set state here - already set in handle functions
      // setNotifPrefs(newPrefs);
      addNotification('Preferences saved', 'success');
    } catch (error) {
      console.error('Failed to save preferences:', error);
      const errorMsg = error?.message || 'Failed to save preferences';
      addNotification(errorMsg, 'error');
    } finally {
      setSaving(false);
    }
  };

  const handleMasterToggle = (checked) => {
    // CRITICAL FIX: Update local state FIRST before async save to prevent race condition
    const newPrefs = {
      ...notifPrefs,
      all_notifications: checked,
      notify_deal_created: checked,
      notify_stage_changed: checked,
      notify_deal_won: checked,
      notify_deal_lost: checked
    };
    setNotifPrefs(newPrefs); // Set immediately
    saveNotificationPreferences(newPrefs); // Then save async
  };

  const handleIndividualToggle = (key, checked) => {
    // CRITICAL FIX: Update local state FIRST before async save
    const newPrefs = {
      ...notifPrefs,
      [key]: checked
    };
    setNotifPrefs(newPrefs); // Set immediately
    saveNotificationPreferences(newPrefs); // Then save async
  };

  const handleWeeklyDigestToggle = (checked, customPrefs = null) => {
    // ROOT CAUSE FIX: Must update local state FIRST before async save
    // This was missing, causing toggle to appear stuck even though it saved
    const newPrefs = customPrefs || {
      ...notifPrefs,
      weekly_digest: checked
    };
    setNotifPrefs(newPrefs); // CRITICAL: Update UI state immediately
    saveNotificationPreferences(newPrefs); // Then save async
  };

  // Pipeline customization - DISABLED FOR BUILD
  // const { stages: pipelineStages, loading: loadingPipeline, industry, resetToTemplate } = usePipelineStages(organization?.id);
  const [editingStages, setEditingStages] = useState([]);
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);

  const tabs = [
    { id: 'general', label: 'General', icon: Shield, dataTour: 'team-settings' }, // Team settings are in General tab
    { id: 'billing', label: 'Billing', icon: CreditCard },
    { id: 'pipeline', label: 'Pipeline', icon: GitBranch },
    { id: 'notifications', label: 'Notifications', icon: Bell }
  ];

  // Removed: Old CDN-based logos - now using SVG components from PROVIDER_CONFIGS

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <button
            onClick={() => setActiveView(VIEWS.DASHBOARD)}
            className="p-2 border border-gray-700 text-gray-400 hover:text-white hover:bg-gray-800/50 rounded-lg transition"
          >
            <ArrowLeft className="w-5 h-5" />
          </button>
          <div>
            <h1 className="text-large-title text-white">Settings</h1>
            <p className="text-subheadline text-gray-400">{organization?.name || 'Your Organization'}</p>
          </div>
        </div>
        <div className="flex items-center gap-3">
          {saving && (
            <div className="flex items-center gap-2 text-teal-400">
              <Loader2 className="w-4 h-4 animate-spin" />
              <span className="text-sm">Saving...</span>
            </div>
          )}
          {/* Sign Out button in header for better UX */}
          <button
            onClick={logout}
            className="flex items-center gap-2 px-4 py-2 border border-red-500/30 text-red-400 hover:bg-red-900/20 rounded-lg transition font-medium"
          >
            <LogOut className="w-4 h-4" />
            <span className="hidden sm:inline">Sign Out</span>
          </button>
        </div>
      </div>

      {/* Tabs */}
      <div className="border-b border-gray-700">
        <nav className="flex gap-8">
          {tabs.map((tab) => {
            const Icon = tab.icon;
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                data-tab={tab.id}
                data-tour={tab.dataTour} // Add data-tour attribute for onboarding
                className={`flex items-center gap-2 pb-4 px-1 border-b-2 transition-colors ${
                  activeTab === tab.id
                    ? 'border-teal-500 text-teal-400'
                    : 'border-transparent text-gray-400 hover:text-white'
                }`}
              >
                <Icon className="w-5 h-5" />
                <span className="font-medium">{tab.label}</span>
              </button>
            );
          })}
        </nav>
      </div>

      {/* Tab Content */}
      {activeTab === 'general' && (
        <Suspense fallback={<TabFallback />}>
          <GeneralSettings
            loadingAI={loadingAI}
            aiUsage={aiUsage}
            aiProviders={aiProviders}
            loading={loading}
            dealCount={dealCount}
            teamCount={teamCount}
            limits={limits}
            user={user}
            organization={organization}
            profilePicUrl={profilePicUrl}
            uploadingImage={uploadingImage}
            fileInputRef={fileInputRef}
            setActiveTab={setActiveTab}
            setActiveView={setActiveView}
            setProfilePicUrl={setProfilePicUrl}
            setUploadingImage={setUploadingImage}
            setAvatarUrl={setAvatarUrl}
            addNotification={addNotification}
          />
        </Suspense>
      )}

      {activeTab === 'billing' && (() => {
        // FIX PHASE 10: Use centralized plan limits config
        const planLimits = getPlanLimits(organization?.plan || 'free');
        return (
          <Suspense fallback={<TabFallback />}>
            <BillingSettings
              organizationId={organization?.id}
              currentPlan={organization?.plan || 'free'}
              usageStats={{
                dealsUsed: dealCount,
                dealsLimit: planLimits.deals,
                usersUsed: teamCount,
                usersLimit: planLimits.users,
                aiRequestsUsed: aiUsage.used || 0,
                aiRequestsLimit: planLimits.aiRequests
              }}
            />
          </Suspense>
        );
      })()}

      {/* PIPELINE TAB TEMPORARILY DISABLED FOR BUILD */}
      {/* {activeTab === 'pipeline' && (
        <div className="max-w-4xl mx-auto space-y-6">
          <SettingCard>
            <div className="flex items-center justify-between mb-6">
              <SectionTitle icon={GitBranch}>Pipeline Stages</SectionTitle>
              <div className="flex items-center gap-2">
                <span className="px-3 py-1 bg-gray-100 dark:bg-gray-800 text-sm font-medium rounded-full capitalize">
                  {industry} Pipeline
                </span>
                {hasUnsavedChanges && (
                  <span className="px-3 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 text-sm font-medium rounded-full flex items-center gap-1">
                    <AlertCircle className="w-3.5 h-3.5" />
                    Unsaved Changes
                  </span>
                )}
              </div>
            </div>

            {loadingPipeline ? (
              <div className="text-center py-12">
                <Loader2 className="w-8 h-8 animate-spin mx-auto mb-3 text-[#1ABC9C]" />
                <p className="text-[#6B7280] dark:text-[#9CA3AF]">Loading pipeline stages...</p>
              </div>
            ) : (
              <div className="space-y-6">
                <div className="space-y-2">
                  {pipelineStages.map((stage, index) => {
                    const Icon = stage.icon;
                    return (
                      <div
                        key={stage.id}
                        className="flex items-center gap-3 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 group hover:border-[#1ABC9C] transition"
                      >
                        <div className="flex items-center gap-3 flex-1">
                          <div 
                            className="w-10 h-10 rounded-lg flex items-center justify-center"
                            style={{ backgroundColor: `${stage.color}20` }}
                          >
                            <Icon className="w-5 h-5" style={{ color: stage.color }} />
                          </div>
                          <div className="flex-1">
                            <div className="font-medium text-[#1A1A1A] dark:text-[#E0E0E0]">
                              {stage.name}
                            </div>
                            <div className="text-xs text-[#6B7280] dark:text-[#9CA3AF]">
                              Stage {index + 1} of {pipelineStages.length}
                            </div>
                          </div>
                        </div>
                        <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition">
                          <button
                            className="p-2 hover:bg-white dark:hover:bg-gray-700 rounded-lg transition"
                            title="Edit stage"
                          >
                            <Edit2 className="w-4 h-4 text-[#6B7280] dark:text-[#9CA3AF]" />
                          </button>
                          <button
                            className="p-2 hover:bg-white dark:hover:bg-gray-700 rounded-lg transition cursor-grab active:cursor-grabbing"
                            title="Reorder"
                          >
                            <GripVertical className="w-4 h-4 text-[#6B7280] dark:text-[#9CA3AF]" />
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>

                <div className="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                  <button
                    onClick={async () => {
                      if (confirm('Reset to default template? This will discard any custom changes.')) {
                        setSaving(true);
                        try {
                          await resetToTemplate();
                          setHasUnsavedChanges(false);
                          addNotification('Pipeline reset to template', 'success');
                        } catch (error) {
                          addNotification('Failed to reset pipeline', 'error');
                        } finally {
                          setSaving(false);
                        }
                      }
                    }}
                    className="flex items-center gap-2 px-4 py-2 text-[#6B7280] dark:text-[#9CA3AF] hover:text-[#1A1A1A] dark:hover:text-[#E0E0E0] hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition font-medium"
                  >
                    <RefreshCw className="w-4 h-4" />
                    Reset to Template
                  </button>

                  <div className="flex items-center gap-3">
                    <button
                      className="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition font-medium text-[#1A1A1A] dark:text-[#E0E0E0]"
                    >
                      <Plus className="w-4 h-4" />
                      Add Stage
                    </button>
                    {hasUnsavedChanges && (
                      <button
                        className="px-6 py-2 bg-[#1ABC9C] text-white rounded-lg hover:bg-[#16A085] transition font-semibold"
                      >
                        Save Changes
                      </button>
                    )}
                  </div>
                </div>

                <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                  <div className="flex items-start gap-3">
                    <Sparkles className="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                    <div className="flex-1">
                      <p className="text-sm font-medium text-blue-900 dark:text-blue-100 mb-1">
                        Pipeline Optimization Tips
                      </p>
                      <ul className="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                        <li>• Keep 5-8 stages for optimal deal flow visibility</li>
                        <li>• Use clear stage names that represent specific actions or milestones</li>
                        <li>• Post-sale stages (Invoice Sent, Payment Received) track revenue completion</li>
                        <li>• Terminal stages (Won/Lost) help with accurate conversion analytics</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </SettingCard>
        </div>
      )} */}

      {activeTab === 'pipeline' && (
        <div className="max-w-4xl mx-auto space-y-6">
          {/* Pipeline Health */}
          <SettingCard data-section="pipeline-health">
            <SectionTitle icon={GitBranch}>Pipeline Health</SectionTitle>

            {loadingHealth ? (
              <div className="flex items-center justify-center py-8">
                <Loader2 className="w-6 h-6 animate-spin text-teal-400" />
                <span className="ml-2 text-gray-400">Checking pipeline health...</span>
              </div>
            ) : pipelineHealth ? (
              <div className="space-y-4">
                {/* Health Score */}
                <div className="p-6 bg-gradient-to-br from-teal-500/10 to-teal-600/10 rounded-xl border border-teal-500/20">
                  <div className="flex items-center justify-between mb-4">
                    <div>
                      <h3 className="text-2xl font-bold text-white">
                        {pipelineHealth.healthPercentage}%
                      </h3>
                      <p className="text-sm text-gray-400">Pipeline Health</p>
                    </div>
                    {pipelineHealth.healthPercentage === 100 ? (
                      <CheckCircle2 className="w-12 h-12 text-teal-400" />
                    ) : pipelineHealth.healthPercentage >= 80 ? (
                      <AlertCircle className="w-12 h-12 text-amber-400" />
                    ) : (
                      <XCircle className="w-12 h-12 text-red-400" />
                    )}
                  </div>

                  <div className="grid grid-cols-3 gap-4 pt-4 border-t border-teal-500/20">
                    <div>
                      <p className="text-2xl font-bold text-teal-400">{pipelineHealth.validDeals}</p>
                      <p className="text-xs text-gray-400">Valid Deals</p>
                    </div>
                    <div>
                      <p className={`text-2xl font-bold ${pipelineHealth.orphanedDeals > 0 ? 'text-red-400' : 'text-gray-400'}`}>
                        {pipelineHealth.orphanedDeals}
                      </p>
                      <p className="text-xs text-gray-400">Orphaned Deals</p>
                    </div>
                    <div>
                      <p className="text-2xl font-bold text-gray-400">{pipelineHealth.totalDeals}</p>
                      <p className="text-xs text-gray-400">Total Deals</p>
                    </div>
                  </div>
                </div>

                {/* Orphaned Deals Warning */}
                {pipelineHealth.orphanedDeals > 0 && (
                  <div className="p-4 bg-amber-900/20 border border-amber-500/30 rounded-lg">
                    <div className="flex items-start gap-3">
                      <AlertCircle className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" />
                      <div className="flex-1">
                        <h4 className="font-semibold text-amber-300 mb-1">
                          Orphaned Deals Found
                        </h4>
                        <p className="text-sm text-amber-400 mb-3">
                          {pipelineHealth.orphanedDeals} deal{pipelineHealth.orphanedDeals > 1 ? 's are' : ' is'} in invalid stages: {pipelineHealth.orphanedStages.join(', ')}.
                          These deals won't appear in your pipeline until recovered.
                        </p>
                        <button
                          onClick={handleRecoverDeals}
                          disabled={recovering}
                          className="flex items-center gap-2 px-4 py-2 bg-amber-500 hover:bg-amber-600 disabled:bg-amber-400 text-white rounded-lg text-sm font-medium shadow-lg shadow-amber-500/20 hover:shadow-amber-500/40 hover:scale-[1.02] active:scale-[0.98] transition"
                        >
                          {recovering ? (
                            <>
                              <Loader2 className="w-4 h-4 animate-spin" />
                              Recovering...
                            </>
                          ) : (
                            <>
                              <Wrench className="w-4 h-4" />
                              Recover Orphaned Deals
                            </>
                          )}
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Refresh Button */}
                <div className="flex justify-end">
                  <button
                    onClick={checkPipelineHealth}
                    disabled={loadingHealth}
                    className="flex items-center gap-2 px-4 py-2 border border-gray-700 text-gray-400 hover:text-white hover:bg-gray-800/50 rounded-lg transition"
                  >
                    <RefreshCw className="w-4 h-4" />
                    Refresh Health Check
                  </button>
                </div>
              </div>
            ) : (
              <div className="text-center py-8">
                <p className="text-gray-400">Unable to load pipeline health</p>
              </div>
            )}
          </SettingCard>

          <SettingCard>
            <SectionTitle icon={Database}>About Pipeline Health</SectionTitle>
            <div className="prose max-w-none">
              <p className="text-sm text-gray-400 mb-4">
                Pipeline health tracks the validity of your deals against your current pipeline template.
                Orphaned deals occur when:
              </p>
              <ul className="text-sm text-gray-400 space-y-2 ml-4">
                <li>You switch pipeline templates and existing deals reference old stages</li>
                <li>Custom stages are deleted but deals still reference them</li>
                <li>Data import creates deals with invalid stage IDs</li>
              </ul>
              <p className="text-sm text-gray-400 mt-4">
                The <strong className="text-white">Recover Orphaned Deals</strong> utility automatically maps orphaned deals to the closest matching stage in your current pipeline, making them visible again.
              </p>
            </div>
          </SettingCard>

          {/* Revenue Targets */}
          <SettingCard data-tour="revenue-targets">
            <SectionTitle icon={TrendingUp}>Revenue Targets</SectionTitle>
            <RevenueTargets
              organization={organization}
              userRole={userRole}
              addNotification={addNotification}
              onSwitchToBilling={() => setActiveTab('billing')}
            />
          </SettingCard>

          {/* Hidden Stages Management */}
          <SettingCard>
            <SectionTitle icon={EyeOff}>Hidden Stages</SectionTitle>
            <HiddenStages
              pipelineStages={
                organization?.pipeline_template
                  ? PIPELINE_TEMPLATES[organization.pipeline_template]?.stages || []
                  : PIPELINE_TEMPLATES.default?.stages || []
              }
            />
          </SettingCard>
        </div>
      )}

      {activeTab === 'notifications' && (
        <div className="max-w-2xl mx-auto">
          <SettingCard>
            <SectionTitle icon={Bell}>Notifications</SectionTitle>
            <div className="space-y-4" data-tour="notifications-settings">
              <div className="flex items-center justify-between py-2 border-b border-gray-700">
                <div className="flex items-center gap-2">
                  <Bell className="w-4 h-4 text-gray-400" />
                  <span className="font-medium text-white">All Notifications</span>
                </div>
                <Toggle
                  checked={notifPrefs.all_notifications}
                  onChange={handleMasterToggle}
                />
              </div>

              {notifPrefs.all_notifications && (
                <div className="pl-6 space-y-3 border-l-2 border-teal-500/20">
                  <div className="flex items-center justify-between py-1">
                    <span className="text-sm text-gray-400">Deal Created</span>
                    <Toggle
                      checked={notifPrefs.notify_deal_created}
                      onChange={(checked) => handleIndividualToggle('notify_deal_created', checked)}
                    />
                  </div>
                  <div className="flex items-center justify-between py-1">
                    <span className="text-sm text-gray-400">Stage Changed</span>
                    <Toggle
                      checked={notifPrefs.notify_stage_changed}
                      onChange={(checked) => handleIndividualToggle('notify_stage_changed', checked)}
                    />
                  </div>
                  <div className="flex items-center justify-between py-1">
                    <span className="text-sm text-gray-400">Deal Won</span>
                    <Toggle
                      checked={notifPrefs.notify_deal_won}
                      onChange={(checked) => handleIndividualToggle('notify_deal_won', checked)}
                    />
                  </div>
                  <div className="flex items-center justify-between py-1">
                    <span className="text-sm text-gray-400">Deal Lost</span>
                    <Toggle
                      checked={notifPrefs.notify_deal_lost}
                      onChange={(checked) => handleIndividualToggle('notify_deal_lost', checked)}
                    />
                  </div>
                </div>
              )}

              <div className="py-2 pt-4 border-t border-gray-700">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <TrendingUp className="w-4 h-4 text-gray-400" />
                    <div>
                      <span className="text-sm font-medium text-white">Weekly Digest</span>
                      <p className="text-xs text-gray-400 mt-0.5">
                        Get a weekly summary of your team's pipeline activity and wins
                      </p>
                    </div>
                  </div>
                  <Toggle
                    checked={notifPrefs.weekly_digest}
                    onChange={handleWeeklyDigestToggle}
                  />
                </div>

                {/* Scheduling Options - Only show when weekly digest is enabled */}
                {notifPrefs.weekly_digest && (
                  <div className="mt-4 ml-6 p-4 bg-gray-800/50 rounded-lg space-y-4">
                    <p className="text-xs font-medium text-gray-400">
                      Delivery Schedule
                    </p>

                    {/* Day Selector */}
                    <div>
                      <label className="block text-xs text-gray-400 mb-1.5">
                        Day of Week
                      </label>
                      <select
                        value={notifPrefs.digest_day}
                        onChange={(e) => {
                          const newPrefs = { ...notifPrefs, digest_day: e.target.value };
                          setNotifPrefs(newPrefs);
                          handleWeeklyDigestToggle(true, newPrefs);
                        }}
                        disabled={!notifPrefs.weekly_digest || saving}
                        className="w-full px-3 py-2 text-sm bg-gray-800/50 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-teal-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        <option value="monday">Monday</option>
                        <option value="tuesday">Tuesday</option>
                        <option value="wednesday">Wednesday</option>
                        <option value="thursday">Thursday</option>
                        <option value="friday">Friday</option>
                        <option value="saturday">Saturday</option>
                        <option value="sunday">Sunday</option>
                      </select>
                    </div>

                    {/* Time Input with Format Toggle */}
                    <div>
                      <div className="flex items-center justify-between mb-1.5">
                        <label className="block text-xs text-gray-400">
                          Time
                        </label>
                        <button
                          type="button"
                          onClick={() => {
                            const newFormat = notifPrefs.digest_time_format === '12h' ? '24h' : '12h';
                            const newPrefs = { ...notifPrefs, digest_time_format: newFormat };
                            setNotifPrefs(newPrefs);
                            handleWeeklyDigestToggle(true, newPrefs);
                          }}
                          disabled={!notifPrefs.weekly_digest || saving}
                          className="text-xs text-teal-400 hover:text-teal-300 font-medium transition disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          Switch to {notifPrefs.digest_time_format === '12h' ? '24-hour' : '12-hour'}
                        </button>
                      </div>

                      {/* CRITICAL FIX: Custom time picker that respects format preference */}
                      {(() => {
                        // Parse the 24h time value (HH:mm)
                        const [hours24, minutes] = (notifPrefs.digest_time || '09:00').split(':').map(Number);
                        const is12hFormat = notifPrefs.digest_time_format === '12h';

                        // Convert to 12h format if needed
                        let displayHours = hours24;
                        let period = 'AM';
                        if (is12hFormat) {
                          period = hours24 >= 12 ? 'PM' : 'AM';
                          displayHours = hours24 % 12 || 12; // Convert 0 to 12, 13-23 to 1-11
                        }

                        // Generate hour options based on format
                        const hourOptions = is12hFormat
                          ? Array.from({ length: 12 }, (_, i) => i + 1) // 1-12 for 12h
                          : Array.from({ length: 24 }, (_, i) => i);     // 0-23 for 24h

                        // Generate minute options (00, 15, 30, 45)
                        const minuteOptions = [0, 15, 30, 45];

                        return (
                          <div className="flex gap-2">
                            {/* Hour Selector */}
                            <select
                              value={displayHours}
                              onChange={(e) => {
                                let newHours24 = parseInt(e.target.value);

                                // Convert back to 24h format if in 12h mode
                                if (is12hFormat) {
                                  if (period === 'PM' && newHours24 !== 12) {
                                    newHours24 += 12;
                                  } else if (period === 'AM' && newHours24 === 12) {
                                    newHours24 = 0;
                                  }
                                }

                                const newTime = `${String(newHours24).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                                const newPrefs = { ...notifPrefs, digest_time: newTime };
                                setNotifPrefs(newPrefs);
                                handleWeeklyDigestToggle(true, newPrefs);
                              }}
                              disabled={!notifPrefs.weekly_digest || saving}
                              className="flex-1 px-3 py-2 text-sm bg-gray-800/50 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-teal-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                              {hourOptions.map(h => (
                                <option key={h} value={h}>
                                  {is12hFormat ? h : String(h).padStart(2, '0')}
                                </option>
                              ))}
                            </select>

                            <span className="flex items-center text-white font-bold">:</span>

                            {/* Minute Selector */}
                            <select
                              value={minutes}
                              onChange={(e) => {
                                const newMinutes = parseInt(e.target.value);
                                const newTime = `${String(hours24).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
                                const newPrefs = { ...notifPrefs, digest_time: newTime };
                                setNotifPrefs(newPrefs);
                                handleWeeklyDigestToggle(true, newPrefs);
                              }}
                              disabled={!notifPrefs.weekly_digest || saving}
                              className="flex-1 px-3 py-2 text-sm bg-gray-800/50 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-teal-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                              {minuteOptions.map(m => (
                                <option key={m} value={m}>
                                  {String(m).padStart(2, '0')}
                                </option>
                              ))}
                            </select>

                            {/* AM/PM Selector (only in 12h mode) */}
                            {is12hFormat && (
                              <select
                                value={period}
                                onChange={(e) => {
                                  const newPeriod = e.target.value;
                                  let newHours24 = displayHours;

                                  // Convert to 24h format
                                  if (newPeriod === 'PM' && displayHours !== 12) {
                                    newHours24 = displayHours + 12;
                                  } else if (newPeriod === 'AM' && displayHours === 12) {
                                    newHours24 = 0;
                                  } else if (newPeriod === 'AM' && displayHours !== 12) {
                                    newHours24 = displayHours;
                                  } else if (newPeriod === 'PM' && displayHours === 12) {
                                    newHours24 = 12;
                                  }

                                  const newTime = `${String(newHours24).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                                  const newPrefs = { ...notifPrefs, digest_time: newTime };
                                  setNotifPrefs(newPrefs);
                                  handleWeeklyDigestToggle(true, newPrefs);
                                }}
                                disabled={!notifPrefs.weekly_digest || saving}
                                className="w-20 px-3 py-2 text-sm bg-gray-800/50 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-teal-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed"
                              >
                                <option value="AM">AM</option>
                                <option value="PM">PM</option>
                              </select>
                            )}
                          </div>
                        );
                      })()}

                      <p className="text-xs text-gray-400 mt-1.5">
                        Select your preferred time in {notifPrefs.digest_time_format === '12h' ? '12-hour' : '24-hour'} format
                      </p>
                    </div>

                    {/* Timezone Selector */}
                    <div>
                      <label className="block text-xs text-gray-400 mb-1.5">
                        Timezone
                      </label>
                      <select
                        value={notifPrefs.digest_timezone}
                        onChange={(e) => {
                          const newPrefs = { ...notifPrefs, digest_timezone: e.target.value };
                          setNotifPrefs(newPrefs);
                          handleWeeklyDigestToggle(true, newPrefs);
                        }}
                        disabled={!notifPrefs.weekly_digest || saving}
                        className="w-full px-3 py-2 text-sm bg-gray-800/50 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-teal-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {/* US Timezones */}
                        <optgroup label="United States">
                          <option value="America/New_York">Eastern Time (ET)</option>
                          <option value="America/Chicago">Central Time (CT)</option>
                          <option value="America/Denver">Mountain Time (MT)</option>
                          <option value="America/Los_Angeles">Pacific Time (PT)</option>
                          <option value="America/Phoenix">Arizona (MST, no DST)</option>
                          <option value="America/Anchorage">Alaska Time (AKT)</option>
                          <option value="Pacific/Honolulu">Hawaii Time (HST)</option>
                        </optgroup>
                        {/* Major International Timezones */}
                        <optgroup label="Europe">
                          <option value="Europe/London">London (GMT/BST)</option>
                          <option value="Europe/Paris">Paris (CET/CEST)</option>
                          <option value="Europe/Berlin">Berlin (CET/CEST)</option>
                          <option value="Europe/Rome">Rome (CET/CEST)</option>
                          <option value="Europe/Madrid">Madrid (CET/CEST)</option>
                          <option value="Europe/Amsterdam">Amsterdam (CET/CEST)</option>
                          <option value="Europe/Brussels">Brussels (CET/CEST)</option>
                          <option value="Europe/Zurich">Zurich (CET/CEST)</option>
                          <option value="Europe/Stockholm">Stockholm (CET/CEST)</option>
                          <option value="Europe/Copenhagen">Copenhagen (CET/CEST)</option>
                          <option value="Europe/Oslo">Oslo (CET/CEST)</option>
                          <option value="Europe/Helsinki">Helsinki (EET/EEST)</option>
                          <option value="Europe/Athens">Athens (EET/EEST)</option>
                          <option value="Europe/Warsaw">Warsaw (CET/CEST)</option>
                          <option value="Europe/Prague">Prague (CET/CEST)</option>
                          <option value="Europe/Vienna">Vienna (CET/CEST)</option>
                          <option value="Europe/Budapest">Budapest (CET/CEST)</option>
                          <option value="Europe/Dublin">Dublin (GMT/IST)</option>
                          <option value="Europe/Lisbon">Lisbon (WET/WEST)</option>
                          <option value="Europe/Moscow">Moscow (MSK)</option>
                        </optgroup>
                        <optgroup label="Asia">
                          <option value="Asia/Tokyo">Tokyo (JST)</option>
                          <option value="Asia/Shanghai">Shanghai (CST)</option>
                          <option value="Asia/Hong_Kong">Hong Kong (HKT)</option>
                          <option value="Asia/Singapore">Singapore (SGT)</option>
                          <option value="Asia/Seoul">Seoul (KST)</option>
                          <option value="Asia/Dubai">Dubai (GST)</option>
                          <option value="Asia/Kolkata">India (IST)</option>
                          <option value="Asia/Bangkok">Bangkok (ICT)</option>
                          <option value="Asia/Manila">Manila (PHT)</option>
                          <option value="Asia/Jakarta">Jakarta (WIB)</option>
                          <option value="Asia/Taipei">Taipei (CST)</option>
                        </optgroup>
                        <optgroup label="Australia & Pacific">
                          <option value="Australia/Sydney">Sydney (AEDT/AEST)</option>
                          <option value="Australia/Melbourne">Melbourne (AEDT/AEST)</option>
                          <option value="Australia/Brisbane">Brisbane (AEST)</option>
                          <option value="Australia/Perth">Perth (AWST)</option>
                          <option value="Pacific/Auckland">Auckland (NZDT/NZST)</option>
                        </optgroup>
                        <optgroup label="Americas">
                          <option value="America/Toronto">Toronto (ET)</option>
                          <option value="America/Vancouver">Vancouver (PT)</option>
                          <option value="America/Mexico_City">Mexico City (CST)</option>
                          <option value="America/Sao_Paulo">São Paulo (BRT)</option>
                          <option value="America/Buenos_Aires">Buenos Aires (ART)</option>
                          <option value="America/Santiago">Santiago (CLT/CLST)</option>
                          <option value="America/Bogota">Bogotá (COT)</option>
                          <option value="America/Lima">Lima (PET)</option>
                        </optgroup>
                        <optgroup label="Africa & Middle East">
                          <option value="Africa/Cairo">Cairo (EET)</option>
                          <option value="Africa/Johannesburg">Johannesburg (SAST)</option>
                          <option value="Africa/Lagos">Lagos (WAT)</option>
                          <option value="Africa/Nairobi">Nairobi (EAT)</option>
                          <option value="Asia/Riyadh">Riyadh (AST)</option>
                          <option value="Asia/Jerusalem">Jerusalem (IST/IDT)</option>
                          <option value="Asia/Istanbul">Istanbul (TRT)</option>
                        </optgroup>
                      </select>
                      <p className="text-xs text-gray-400 mt-1.5">
                        Current timezone: {notifPrefs.digest_timezone.replace(/_/g, ' ')}
                      </p>
                    </div>

                    {/* Confirmation Message */}
                    <div className="pt-3 border-t border-gray-700">
                      <p className="text-xs text-teal-400 flex items-start gap-2">
                        <CheckCircle className="w-4 h-4 flex-shrink-0 mt-0.5" />
                        <span>
                          Email will be sent every <strong>{notifPrefs.digest_day.charAt(0).toUpperCase() + notifPrefs.digest_day.slice(1)}</strong> at <strong>{(() => {
                            const time = notifPrefs.digest_time;
                            const [hours, minutes] = time.split(':');
                            const hour = parseInt(hours);
                            const min = minutes || '00';

                            if (notifPrefs.digest_time_format === '24h') {
                              return `${hours.padStart(2, '0')}:${min}`;
                            }

                            // 12-hour format
                            if (hour === 0) return `12:${min} AM`;
                            if (hour < 12) return `${hour}:${min} AM`;
                            if (hour === 12) return `12:${min} PM`;
                            return `${hour - 12}:${min} PM`;
                          })()}</strong> ({notifPrefs.digest_timezone.split('/').pop().replace(/_/g, ' ')})
                        </span>
                      </p>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </SettingCard>
        </div>
      )}

      {/* Orphaned Deals Modal */}
      <OrphanedDealsModal
        isOpen={showOrphanedDealsModal}
        onClose={() => setShowOrphanedDealsModal(false)}
        organization={organization}
        currentStages={
          organization
            ? PIPELINE_TEMPLATES[organization.pipeline_template || 'default'].stages.map((s, i) => ({
                id: s.id,
                name: s.name,
                stage_order: i
              }))
            : []
        }
        onSuccess={handleOrphanedDealsSuccess}
      />
    </div>
  );
};

export default Settings;
